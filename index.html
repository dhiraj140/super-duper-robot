<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tender Result Portal | Public</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Fixed header with news bar -->
  <header class="fixed-header">
    <div class="logo-bar">
      <div class="logo">ğŸ›ï¸</div>
      <span class="site-title">Tender Result Portal</span>
    </div>
    <div class="news-bar">
      <div class="scrolling-wrapper">
        <span class="news-text">ğŸ“¢ New Tender Results Published | Check Latest Awarded Tenders | Updated Today | Railway Tenders Out | â‚¹50 Cr Projects</span>
        <span class="news-text">ğŸ“¢ New Tender Results Published | Check Latest Awarded Tenders | Updated Today | Railway Tenders Out | â‚¹450 Cr Projects</span>
        <span class="news-text">ğŸ“¢ New Tender Results Published | Check Latest Awarded Tenders | Updated Today | Pwd Tender Out | â‚¹120 Cr Projects</span>
         <span class="news-text">ğŸ“¢ New Tender Results Published | Check Latest Awarded Tenders | Updated Today | Pwd Tender Out | â‚¹12 Cr Projects</span>
         <span class="news-text">ğŸ“¢ New Tender Results Published | Check Latest Awarded Tenders | Updated Today | Pwd Tender Out | â‚¹10 Cr Projects</span>
         <span class="news-text">ğŸ“¢ New Tender Results Published | Check Latest Awarded Tenders | Updated Today | Pwd Tender Out | â‚¹1 Cr Projects</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Search & Filter -->
    <div class="card">
      <h2>ğŸ” Find Tenders</h2>
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="Search by Tender No or Work Name">
        <select id="statusFilter">
          <option value="All">All Status</option>
          <option value="Selected">Selected</option>
          <option value="Cancelled">Cancelled</option>
          <option value="Under Evaluation">Under Evaluation</option>
        </select>
      </div>
    </div>

    <!-- Tender Results Table -->
    <div class="card">
      <h2>ğŸ“‹ Tender Result List</h2>
      <div class="table-responsive" id="tableContainer">
        <!-- Table dynamically inserted by JS -->
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>âš ï¸ This portal displays demo tender data for testing. Official results may vary.</p>
      <p>Last Updated: <span id="lastUpdated"></span></p>
    </footer>
  </main>

  <script type="module">
    // ========== PUBLIC PAGE SCRIPT ==========
    import { loadTenders, saveTenders, getStatusClass, generateTenderPDF } from './js/app.js';

    let tenders = loadTenders();
    const tableContainer = document.getElementById('tableContainer');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const lastUpdatedSpan = document.getElementById('lastUpdated');

    // Render table based on current filter + search
    function renderTable() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const status = statusFilter.value;

      const filtered = tenders.filter(t => {
        const matchesSearch = t.tenderNo.toLowerCase().includes(searchTerm) ||
                              t.workName.toLowerCase().includes(searchTerm);
        const matchesStatus = status === 'All' || t.status === status;
        return matchesSearch && matchesStatus;
      });

      if (filtered.length === 0) {
        tableContainer.innerHTML = '<p style="text-align:center; padding:3rem;">No tender results available.</p>';
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Tender No</th><th>Work Name</th><th>Department</th><th>Cost (â‚¹)</th>
            <th>Bid Date</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody>`;

      filtered.forEach(t => {
        const statusClass = getStatusClass(t.status);
        html += `<tr>
          <td><strong>${t.tenderNo}</strong></td>
          <td>${t.workName}</td>
          <td>${t.department}</td>
          <td>â‚¹ ${t.cost.toLocaleString()}</td>
          <td>${t.date}</td>
          <td><span class="status-badge ${statusClass}">${t.status}</span></td>
          <td class="action-cell">
            <button class="btn-icon view-btn" data-id="${t.id}">ğŸ“„ View</button>
            <button class="btn-icon pdf-btn" data-id="${t.id}">â¬‡ï¸ PDF</button>
          </td>
        </tr>`;
      });

      html += '</tbody></table>';
      tableContainer.innerHTML = html;
    }

    // Event delegation for view / PDF buttons
    tableContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const tenderId = btn.dataset.id;
      const tender = tenders.find(t => t.id === tenderId);
      if (!tender) return;

      if (btn.classList.contains('view-btn')) {
        generateTenderPDF(tender, false);
      } else if (btn.classList.contains('pdf-btn')) {
        generateTenderPDF(tender, true); // autoâ€‘print
      }
    });

    // Update when localStorage changes (e.g., from admin tab)
    window.addEventListener('tendersUpdated', () => {
      tenders = loadTenders();
      renderTable();
    });

    // Also listen to native storage event for crossâ€‘tab sync
    window.addEventListener('storage', (e) => {
      if (e.key === 'tenderPortalData') {
        tenders = loadTenders();
        renderTable();
      }
    });

    // Filter triggers
    searchInput.addEventListener('input', renderTable);
    statusFilter.addEventListener('change', renderTable);

    // Set last updated date
    lastUpdatedSpan.textContent = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });

    // Initial render
    renderTable();
  </script>
</body>
</html>
